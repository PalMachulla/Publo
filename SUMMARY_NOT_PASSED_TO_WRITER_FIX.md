# Summary Not Passed to WriterAgent - CRITICAL FIX

## Problem

Content generated by WriterAgent was completely unrelated to the story:
- **User requested:** "Write a short story about herrings"
- **Summary said:** "Herrings sense an unusual shift in the ocean current..."
- **Content generated:** "Emily Wilson sat by the window in Ravenswood..." (completely random!)

**Root Cause:** The `summary` field from structure items was NOT being passed to the WriterAgent.

---

## Investigation

### **WriterAgent.ts (Line 133-138)**
The WriterAgent was correctly trying to use the summary:

```typescript
if (taskContext.section) {
  const { name, description, summary } = taskContext.section as any
  prompt += `## Section: ${name}\n`
  
  // ‚úÖ CRITICAL: Use summary as primary guidance
  if (summary) {
    prompt += `\n**REQUIRED CONTENT:**\n${summary}\n`
    prompt += `\n‚ö†Ô∏è Your content MUST accomplish what is described above.\n\n`
  }
}
```

### **WriteContentTool.ts (Line 145-149) - THE BUG**
But the `WriteContentTool` was creating the task WITHOUT the summary:

```typescript
section: {
  id: sectionId,
  name: sectionName || sectionId,
  description: prompt  // ‚ùå User's message, not the summary!
  // ‚ùå summary field is MISSING!
}
```

**Result:** `taskContext.section.summary` was `undefined`, so the WriterAgent had NO guidance about what to write!

---

## Solution

### **Fixed WriteContentTool.ts**

**1. Get structure items FIRST** (before creating the task):
```typescript
// ‚úÖ FIX: Get structure and content context from WorldState FIRST
const activeDoc = worldState.getActiveDocument()
const structureItems = activeDoc.structure?.items || []
const contentMap = activeDoc.content ? Object.fromEntries(activeDoc.content) : {}

// ‚úÖ CRITICAL: Find the structure item to get its summary
const targetStructureItem = structureItems.find(item => item.id === sectionId)

console.log(`üìö [WriteContentTool] Structure context:`, {
  structureItemsCount: structureItems.length,
  targetSection: targetStructureItem?.name,
  hasSummary: !!targetStructureItem?.summary,
  summary: targetStructureItem?.summary?.substring(0, 100)
})
```

**2. Include summary in the task**:
```typescript
section: {
  id: sectionId,
  name: sectionName || targetStructureItem?.name || sectionId,
  description: prompt,
  summary: targetStructureItem?.summary || undefined, // ‚úÖ CRITICAL: Include summary!
  title: targetStructureItem?.title || undefined,
  level: targetStructureItem?.level || undefined
}
```

---

## How It Works Now

1. **Orchestrator creates structure** with summaries:
   ```json
   {
     "id": "scene1",
     "name": "Scene 1 - A Change in the Current",
     "summary": "Herrings sense an unusual shift in the ocean current, prompting anxiety and speculation among the shoal."
   }
   ```

2. **WriteContentTool receives** `generate_content` action with `sectionId: "scene1"`

3. **WriteContentTool looks up** the structure item from `WorldState`:
   ```typescript
   const targetStructureItem = structureItems.find(item => item.id === "scene1")
   // targetStructureItem.summary = "Herrings sense an unusual shift..."
   ```

4. **Task is created** with the summary:
   ```typescript
   section: {
     id: "scene1",
     name: "Scene 1 - A Change in the Current",
     summary: "Herrings sense an unusual shift in the ocean current..."
   }
   ```

5. **WriterAgent receives** the task and builds the prompt:
   ```
   **REQUIRED CONTENT:**
   Herrings sense an unusual shift in the ocean current, prompting anxiety and speculation among the shoal.
   
   ‚ö†Ô∏è Your content MUST accomplish what is described above.
   ```

6. **Content is generated** about herrings (not Emily Wilson!)

---

## Files Modified

1. ‚úÖ `frontend/src/lib/orchestrator/tools/writeContentTool.ts` - Pass summary to WriterAgent

---

## Testing

**Test Case: Herring Story**
```
USER: Write a short story about herrings. Write chapter 2.
ORCHESTRATOR: Creates structure with summary: "Herrings sense an unusual shift..."
WRITER AGENT: Receives summary in task
CONTENT GENERATED: Story about herrings sensing ocean currents (CORRECT!)
```

**Before Fix:**
- Content: "Emily Wilson sat by the window in Ravenswood..."
- ‚ùå Completely unrelated to herrings

**After Fix:**
- Content: "The shoal of herrings moved through the dark waters, their silver bodies flashing as they sensed the unusual shift in the current..."
- ‚úÖ Matches the summary!

---

## Why This Was Critical

Without the summary:
- ‚ùå WriterAgent had NO guidance on what to write
- ‚ùå Generated random content unrelated to the story
- ‚ùå User's prompt was ignored
- ‚ùå Structure was useless

With the summary:
- ‚úÖ WriterAgent knows exactly what to write
- ‚úÖ Content matches the orchestrator's plan
- ‚úÖ Story is coherent across sections
- ‚úÖ User gets what they asked for

---

## Related Fixes

This fix works together with:
1. **WriterAgent.ts** - Already prioritizes summary (line 137)
2. **Progress Indicators** - Shows what's being written
3. **Follow-up Intent** - LLM understands "first", "second", etc.

All three fixes are now in place for a complete content generation flow! üéâ

